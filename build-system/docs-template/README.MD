# Генерация и деплой документации Docusaurus

Этот модуль предоставляет инфраструктуру для генерации и деплоя документации с помощью [Docusaurus](https://docusaurus.io/).

## Структура шаблонов

При генерации документации используются шаблоны, находящиеся в `build-system/docs-template/`:

- `common-template/` — содержит общие файлы, необходимые для любой документации (например, конфиги, базовые стили, favicon, и т.п.).
- `compose-template/` — содержит специфичные шаблоны и документы, применимые для библиотек на основе Jetpack Compose.
- `xml-template/` — содержит шаблоны для библиотек, использующих XML-компоненты.

В зависимости от типа библиотеки (`isComposeLib()`), будет выбрана соответствующая поддиректория с шаблонами. Все шаблоны объединяются в итоговую структуру, которая затем модифицируется и используется для генерации Docusaurus-документации.

## Основные Gradle таски

### `docusaurusGenerate`

Создаёт локальную копию документации на основе шаблонов:
- Копирует `common-template/`
- Добавляет `compose-template/` или `xml-template/` в зависимости от типа библиотеки
- Применяет подстановки значений в шаблоны (placeholders)
- Поверх всех шаблонов применяет `override-docs/`, если он существует в модуле

Результат сохраняется в директорию `build/generated/docusaurus`.

### `docusaurusBuild`

Выполняет `yarn install` и `yarn build` внутри директории, созданной `docusaurusGenerate`. На выходе формирует финальные HTML-артефакты в `build/generated/docusaurus/build`.

Используется как промежуточный этап перед деплоем.

### `docusaurusRun`

Локально запускает сайт документации в браузере (`yarn start`), на основе текущей сгенерированной структуры. Удобно для локального предпросмотра.

### `docusaurusBump`

Обновляет или создаёт файл `override-docs/versionsArchived.json`, добавляя туда текущую версию артефакта и ссылку на неё. Используется для отображения доступных версий документации в выпадающем списке Docusaurus.

### `docusaurusDeploy`

Загружает содержимое из `build/generated/docusaurus/build` в S3-бакет. Параметры подключения к S3 берутся из Gradle-параметров или переменных окружения (`s3-accessKeyId`, `s3-secretAccessKey`, `s3-endpoint`, `s3-region`, `s3-bucket`).

Целевой путь внутри бакета строится на основе версии и артефакта:
```
s3://<bucket>/<ветка>/<тип>/<artifactId>/<версия>/
```

Где: 
 - [ветка] - одно из значений [dev] (для сборок на develop), [current] (для сборок на main), [pr/...] (для сборок на PR)
 - [тип] - одно из значений [xml], [compose]
 - [artifactId] - идентификатор библиотеки в Maven
 - [версия] - версия библиотеки в Maven
### `docusaurusClean`

Удаляет сгенерированную ранее документацию с сервера (т.е. очищает соответствующий путь в S3).

## Пример использования

Полная последовательность генерации и деплоя документации:

```bash
./gradlew docusaurusGenerate       # Сгенерировать локальную копию из шаблонов
./gradlew docusaurusRun           # Посмотреть локально
./gradlew docusaurusBuild         # Собрать статическую версию
./gradlew docusaurusBump          # Обновить список версий
./gradlew docusaurusDeploy        # Залить на сервер
```

При необходимости можно сначала очистить удалённый путь:

```bash
./gradlew docusaurusClean
```

## Настройки и параметры

Все переменные можно задать в `gradle.properties`, `local.properties` или через переменные окружения:

- `s3-accessKeyId` / `S3_ACCESS_KEY_ID`
- `s3-secretAccessKey` / `S3_SECRET_ACCESS_KEY`
- `s3-endpoint` / `S3_ENDPOINT`
- `s3-region` / `S3_REGION`
- `s3-bucket` / `S3_BUCKET`
